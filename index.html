<!DOCTYPE = html>
<html lang="en">

  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Movie Thing</title>


    <script>


      // let lat;
      // let long;

      // const getLocation = () => {
      // return(navigator.geolocation.getCurrentPosition(showPosition));

      // } 

      var UserCoords = { lat: '', long: '' };
      function getLocation() {
          if (navigator.geolocation) {
              navigator.geolocation.getCurrentPosition(showPosition);

          } else {
              alert("Geolocation is not supported by this browser.");
          }
      }

      function processInfo(data1,latLong){

          //inital processing of data, resetting current list to empty
            console.log(data1);
            document.getElementById("locations").innerHTML = "";
            //var to store temp data of destination for each iteration over each location
            let destinationInfo;
            let retString;

            //parent ul
            let list = document.getElementById("locations");
            //initializing a sub ul for each item in the list of movies
            let i = 0;
            data1.forEach((item) => {
              let name = data1[i].name;
              let li = document.createElement("li");
              try {
                let headers = new Headers();
                headers.append("origin", null);
                console.log(data1[i].geometry.location.lat);
                console.log(data1[i].geometry.location.lng);
                fetch(`https://stormy-earth-41391.herokuapp.com/https://maps.googleapis.com/maps/api/distancematrix/json?destinations=${data1[i].geometry.location.lat}, ${data1[i].geometry.location.lng}&origins=${latLong.lat},${latLong.long}&units=imperial&key=AIzaSyCDrxi1blX3JmChSsup4Z8bSd62On_FcFE`,{
                    method: 'GET',
                    headers: headers
                })
            .then(response => response.json())
            .then(data => {destinationInfo = data;
              console.log(destinationInfo);
              console.log(name);
              
              retString = name + '<ul>'
              + '<li>' + 'Address: ' + destinationInfo.destination_addresses[0] + "</li>"
              + '<li>' + 'Distance: ' + destinationInfo.rows[0].elements[0].distance.text+ "</li>"
              + '<li>' + 'Estimated Travel Time: ' + destinationInfo.rows[0].elements[0].duration.text + "</li>"

              + '</ul>'
             
              console.log(retString);
              
              
              li.innerHTML = retString;
              list.appendChild(li);       
              })
              } catch (e) {
                console.log(e);
              };  

              i++;
            }
            
            );

            //getting each sub ul
            // let listElements = Array.from(document.querySelectorAll('ul ul'));
            // for(let i = 0; i < listElements.length; i++){
              
            //   //fetching data, destination info is the response object


            // }        
      }

      function showPosition(position) {
          UserCoords.lat = position.coords.latitude;
          UserCoords.long = position.coords.longitude;
          console.log(UserCoords);//Works
      }

      function getUserCoords(radius) {
          var promise1 = new Promise(function(resolve, reject) {
            navigator.geolocation.getCurrentPosition(function(pos){
                lat = pos.coords.latitude
                long = pos.coords.longitude
                resolve({lat,long});
              }) 
          })

          promise1.then(function(value) {
            let headers = new Headers();
            headers.append('Access-Control-Allow-Origin', "<Origin>");
            headers.append('mode', "no-cors");

            try {
                fetch(`https://stormy-earth-41391.herokuapp.com/https://maps.googleapis.com/maps/api/place/nearbysearch/json?location=${value.lat},${value.long}&radius=${radius}&types=movie_theater&name=movie&key=AIzaSyCDrxi1blX3JmChSsup4Z8bSd62On_FcFE`,{
                    method: 'GET',
                    headers: headers
                })
            .then(response => response.json())
            .then(data => processInfo(data.results, {lat,long}))
              } catch (e) {
                console.log(e);
              };

          });
      }
    </script>
    
  </head>


  <body>
        
    <button id= "start" onclick= "getUserCoords(document.getElementById('radius').value)">Start the service. You will need to enable location services.</button>

    <label for="radius">Radius for search(100-50000):</label>

    <input id = "radius" max= 50000 type="number" min="100"> 

    <ul id = "locations"></ul>

    <p id= "wasd"></p>
    <div id="googleMap" style="width:100%;height:400px"></div>

  </body>
  <script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.8.1/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.8.1/firebase-analytics.js";
    // TODO: Add SDKs for Firebase products that you want to use
    // https://firebase.google.com/docs/web/setup#available-libraries
  
    // Your web app's Firebase configuration
    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
    const firebaseConfig = {
      apiKey: "AIzaSyBghUa-5tF1PIMHwPHyTUuXj-5brkUypgA",
      authDomain: "filmfinder-3a092.firebaseapp.com",
      databaseURL: "https://filmfinder-3a092-default-rtdb.firebaseio.com",
      projectId: "filmfinder-3a092",
      storageBucket: "filmfinder-3a092.appspot.com",
      messagingSenderId: "127139994519",
      appId: "1:127139994519:web:3eb049049ede5fd74682d2",
      measurementId: "G-EWJEXEX2M1"
    };
  
    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
  </script>


</html>