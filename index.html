<!DOCTYPE = html>
<html lang="en">

  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Movie Thing</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Raleway:wght@100;300&display=swap" rel="stylesheet">

    <script>


      // let lat;
      // let long;

      // const getLocation = () => {
      // return(navigator.geolocation.getCurrentPosition(showPosition));

      // } 

      var UserCoords = { lat: '', long: '' };
      function getLocation() {
          if (navigator.geolocation) {
              navigator.geolocation.getCurrentPosition(showPosition);

          } else {
              alert("Geolocation is not supported by this browser.");
          }
      }

      function processInfo(data1,latLong){

          //inital processing of data, resetting current list to empty
            console.log(data1);
            document.getElementById("locations").innerHTML = "";
            //var to store temp data of destination for each iteration over each location
            let destinationInfo;
            let retString;

            //parent ul
            let list = document.getElementById("locations");
            //initializing a sub ul for each item in the list of movies
            let i = 0;
            data1.forEach((item) => {
              let name = data1[i].name;
              let li = document.createElement("li");
              try {
                let headers = new Headers();
                headers.append("origin", null);
                console.log(data1[i].geometry.location.lat);
                console.log(data1[i].geometry.location.lng);
                fetch(`https://stormy-earth-41391.herokuapp.com/https://maps.googleapis.com/maps/api/distancematrix/json?destinations=${data1[i].geometry.location.lat}, ${data1[i].geometry.location.lng}&origins=${latLong.lat},${latLong.long}&units=imperial&key=AIzaSyCDrxi1blX3JmChSsup4Z8bSd62On_FcFE`,{
                    method: 'GET',
                    headers: headers
                })
            .then(response => response.json())
            .then(data => {destinationInfo = data;
              console.log(destinationInfo);
              console.log(name);
              
              retString = name + '<ul>'
              + '<li>' + 'Address: ' + destinationInfo.destination_addresses[0] + "</li>"
              + '<li>' + 'Distance: ' + destinationInfo.rows[0].elements[0].distance.text+ "</li>"
              + '<li>' + 'Estimated Travel Time: ' + destinationInfo.rows[0].elements[0].duration.text + "</li>"

              + '</ul>'
             
              console.log(retString);
              
              
              li.innerHTML = retString;
              list.appendChild(li);       
              })
              } catch (e) {
                console.log(e);
              };  

              i++;
            }
            
            );

            //getting each sub ul
            // let listElements = Array.from(document.querySelectorAll('ul ul'));
            // for(let i = 0; i < listElements.length; i++){
              
            //   //fetching data, destination info is the response object


            // }        
      }

      function showPosition(position) {
          UserCoords.lat = position.coords.latitude;
          UserCoords.long = position.coords.longitude;
          console.log(UserCoords);//Works
      }

      function getUserCoords(radius) {
          var promise1 = new Promise(function(resolve, reject) {
            navigator.geolocation.getCurrentPosition(function(pos){
                lat = pos.coords.latitude
                long = pos.coords.longitude
                resolve({lat,long});
              }) 
          })

          promise1.then(function(value) {
            let headers = new Headers();
            headers.append('Access-Control-Allow-Origin', "<Origin>");
            headers.append('mode', "no-cors");

            try {
                fetch(`https://stormy-earth-41391.herokuapp.com/https://maps.googleapis.com/maps/api/place/nearbysearch/json?location=${value.lat},${value.long}&radius=${radius}&types=movie_theater&name=movie&key=AIzaSyCDrxi1blX3JmChSsup4Z8bSd62On_FcFE`,{
                    method: 'GET',
                    headers: headers
                })
            .then(response => response.json())
            .then(data => processInfo(data.results, {lat,long}))
              } catch (e) {
                console.log(e);
              };

          });
      }
    </script>
    
    <style>
      body{
        font-family: 'Raleway', sans-serif;
        padding:0px;
        background-color: rgb(73, 73, 73);
        color: rgba(255, 255, 255, 0.87);
        margin:0px;
      }

      .menu-bar{
        display:grid;
        width:viewport-width;
        height:75px;
        background-color:rgb(60,60,60);
      }

      .icon-container{
        padding:15px;
      }

      .filmfinder-icon{
        height:45px;
        width:45px;
      }

      .main{
        display: grid;
      }

      #radius{
        font-size: 2em;
        border:0px;
      }

      #radius:focus{
        border-bottom: black, 2px;
        transition-duration: 0.5s;
      }

      .radius-label{
        font-size:3em;
      }
    </style>

  </head>


  <body>
    <div class="menu-bar">
      <div class="icon-container">
        <img class="filmfinder-icon" src="/assets/FilmFinder.png">
      </div>
    </div>
    <div class="main">
      <div class="">
        <label class="radius-label"for="radius">Radius for search(100-50000):</label>

        <input id = "radius" max= 50000 type="number" min="100">
      </div>
      <div>
        <button id= "start" onclick= "getUserCoords(document.getElementById('radius').value)">Start the service. You will need to enable location services.</button>

        <ul id = "locations"></ul>
    
        <p id= "wasd"></p>
      </div>
    </div>



    <div id="googleMap" style="width:100%;height:400px"></div>

  </body>


</html>